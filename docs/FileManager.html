<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphForge File Access</title>
    <link rel="stylesheet" href="styles/main.css">
  </head>
  <body>
    <h1>GraphForge File Access</h1>
    <button id="initializeButton">Initialize App Folder</button>
    <button id="createDemo">Create Demo Project</button>
    <button id="showDirectory">Show Directory</button>
    <div class="initialize-website-info">
      <h2>Initialize Website</h2>
      <button id="initializeAppButton">Initialize GraphForge</button>
      <p>To get started, please create a folder on your computer where GraphForge will have read/write access.</p>
    </div>
    <div id="project-menu" class="project-menu">
      <button id="createNewProject" onclick="createNewProject()">+ New Project</button>
    </div>
    <div id="context-menu" class="context-menu">
      <ul>
        <li id="edit">Edit</li>
        <li id="rename">Rename</li>
        <li id="duplicate">Duplicate</li>
        <li id="delete">Delete</li>
      </ul>
    </div>
    <script>
      const PREDEFINED_FOLDER_NAME = "GraphForge";
      const dbName = 'GraphForgeDB';
      let appFolderHandle;

      // Pure function to open IndexedDB and return a Promise that resolves with the DB instance
      function openDatabase() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(dbName, 1);
          request.onupgradeneeded = event => {
            const db = event.target.result;
            db.createObjectStore('handles');
          };
          request.onsuccess = event => resolve(event.target.result);
          request.onerror = event => reject(event.target.error);
        });
      }

      // Pure function to store a folder handle in IndexedDB
      function storeFolderHandle(db, handle) {
        const transaction = db.transaction(['handles'], 'readwrite');
        const store = transaction.objectStore('handles');
        const request = store.put(handle, 'appFolderHandle');
        return new Promise((resolve, reject) => {
          request.onsuccess = () => resolve();
          request.onerror = (event) => reject(event.target.error);
        });
      }

      // Pure function to retrieve a folder handle from IndexedDB
      function getStoredFolderHandle(db) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(['handles'], 'readonly');
          const store = transaction.objectStore('handles');
          const request = store.get('appFolderHandle');
          request.onsuccess = event => resolve(event.target.result);
          request.onerror = (event) => reject(event.target.error);
        });
      }

      // Pure function to create a folder handle inside the app folder
      async function createAppFolder() {
        try {
          const baseDirectoryHandle = await window.showDirectoryPicker();
          const folderHandle = await baseDirectoryHandle.getDirectoryHandle(PREDEFINED_FOLDER_NAME, { create: true });
          return folderHandle;
        } catch (error) {
          throw new Error("Error accessing or creating folder: " + error);
        }
      }
      async function createDemo(appFolderHandle) {
        if (!appFolderHandle) {
          console.error("App folder handle not found. Initialize the app first.");
          return;
        }
        try {
          // Create Project Demo folder
          const demoFolder = await appFolderHandle.getDirectoryHandle("Project Demo", {
            create: true
          });
          // Create Source Data folder inside Project Demo
          const sourceDataFolder = await demoFolder.getDirectoryHandle("Source Data", {
            create: true
          });
          // Create and write to yourData.txt inside Source Data
          const yourDataFile = await sourceDataFolder.getFileHandle("yourData.txt", {
            create: true
          });
          const writable = await yourDataFile.createWritable();
          await writable.write("Sample data for your demo.");
          await writable.close();
          console.log("Demo project created successfully.");
        } catch (error) {
          console.error("Error creating demo project:", error);
        }
      }
      // Function to initialize the app by setting up the database and retrieving the stored folder handle
      async function initializeApp() {
        const db = await openDatabase();
        appFolderHandle = await getStoredFolderHandle(db);
        if (!appFolderHandle) {
          console.log("App folder not initialized.");
        }
      }

      // Function to show the directory in the UI
      async function showDirectory() {
        if (!appFolderHandle) {
          alert("Please initialize the app folder first.");
          return;
        }

        const projectMenu = document.getElementById('project-menu');
        const projectList = document.createElement('ul');

        try {
          const demoFolder = await appFolderHandle.getDirectoryHandle("Project Demo");
          const sourceDataFolder = await demoFolder.getDirectoryHandle("Source Data");

          // Add Project Demo to the list
          const projectItem = document.createElement('li');
          projectItem.className = "project";
          projectItem.setAttribute('data-name', "Project Demo");

          const projectHeader = document.createElement('div');
          projectHeader.className = "projectHeader";
          projectHeader.textContent = "Project Demo";

          const sourceDataItem = document.createElement('li');
          sourceDataItem.className = "project-folder";
          sourceDataItem.setAttribute('data-name', "Source Data");
          sourceDataItem.innerHTML = `ðŸ–¿ Source Data <span class="upload-doc" onclick="uploadDocument(event)">+ Doc</span>`;

          // Create the fileNames <ul>
          const fileNamesList = document.createElement('ul');
          fileNamesList.id = "fileNames";

          const fileItem = document.createElement('li');
          fileItem.className = "file";
          fileItem.setAttribute('data-name', "test file");
          fileItem.textContent = "test file.txt";

          fileNamesList.appendChild(fileItem);
          sourceDataItem.appendChild(fileNamesList);
          projectItem.appendChild(projectHeader);
          projectItem.appendChild(sourceDataItem);
          projectList.appendChild(projectItem);

          // Insert the new directory list into the project menu
          projectMenu.appendChild(projectList);
        } catch (error) {
          console.error("Error displaying directory:", error);
        }
      }

      // Event listeners for UI buttons
      document.addEventListener('DOMContentLoaded', () => {
        const initializeButton = document.getElementById('initializeButton');
        const createDemoButton = document.getElementById('createDemo');
        const showDirectoryButton = document.getElementById('showDirectory');

        initializeButton.addEventListener('click', async () => {
          const db = await openDatabase();
          appFolderHandle = await createAppFolder();
          await storeFolderHandle(db, appFolderHandle);
        });

        createDemoButton.addEventListener('click', async () => {
          if (!appFolderHandle) {
            alert("Please initialize the app folder first.");
            return;
          }
          await createDemo(appFolderHandle);
        });

        // Show directory button click event
        showDirectoryButton.addEventListener('click', showDirectory);

        // Initialize app when page loads
        initializeApp();
      });
    </script>
  </body>
</html>
